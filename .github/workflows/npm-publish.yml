name: Publish npm packages

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

permissions:
  contents: read

jobs:
  publish-platforms:
    name: Publish ${{ matrix.platform }}
    # Only run if Release workflow succeeded and was triggered by a tag
    if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: darwin-arm64
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-aarch64-apple-darwin.tar.gz
            binary: cc-audit
          - platform: darwin-x64
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-x86_64-apple-darwin.tar.gz
            binary: cc-audit
          - platform: linux-arm64
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-aarch64-unknown-linux-gnu.tar.gz
            binary: cc-audit
          - platform: linux-x64
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-x86_64-unknown-linux-gnu.tar.gz
            binary: cc-audit
          - platform: linux-x64-musl
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-x86_64-unknown-linux-musl.tar.gz
            binary: cc-audit
          - platform: win32-x64
            artifact: cc-audit-${{ github.event.workflow_run.head_branch }}-x86_64-pc-windows-msvc.zip
            binary: cc-audit.exe

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download release artifact
        run: |
          gh release download ${{ github.event.workflow_run.head_branch }} \
            --pattern "${{ matrix.artifact }}" \
            --dir ./tmp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract binary
        run: |
          mkdir -p npm/${{ matrix.platform }}/bin
          cd tmp
          if [[ "${{ matrix.artifact }}" == *.zip ]]; then
            unzip *.zip
          else
            tar -xzf *.tar.gz
          fi
          mv ${{ matrix.binary }} ../npm/${{ matrix.platform }}/bin/
          chmod +x ../npm/${{ matrix.platform }}/bin/* || true

      - name: Update version in package.json
        run: |
          VERSION="${{ github.event.workflow_run.head_branch }}"
          VERSION="${VERSION#v}"
          cd npm/${{ matrix.platform }}
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json
          mv tmp.json package.json

      - name: Publish platform package
        run: |
          cd npm/${{ matrix.platform }}
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-main:
    name: Publish main package
    needs: publish-platforms
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update version in package.json
        run: |
          VERSION="${{ github.event.workflow_run.head_branch }}"
          VERSION="${VERSION#v}"
          cd npm/cc-audit
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          jq --arg v "$VERSION" '.optionalDependencies |= with_entries(.value = $v)' package.json > tmp.json
          mv tmp.json package.json

      - name: Publish main package
        run: |
          cd npm/cc-audit
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
