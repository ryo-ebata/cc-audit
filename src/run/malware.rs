//! Malware database scanning.

use crate::{DirectoryWalker, Finding, MalwareDatabase, WalkConfig};
use std::fs;
use std::path::Path;
use tracing::debug;

use super::text_file::{is_config_file, is_text_file};

/// Scan a path for malware signatures.
pub fn scan_path_with_malware_db(path: &Path, db: &MalwareDatabase) -> Vec<Finding> {
    let mut findings = Vec::new();

    if path.is_file() {
        // Skip config files
        if !is_config_file(path)
            && let Ok(content) = fs::read_to_string(path)
        {
            debug!(path = %path.display(), "Scanning file for malware signatures");
            findings.extend(db.scan_content(&content, &path.display().to_string()));
        }
    } else if path.is_dir() {
        debug!(path = %path.display(), "Scanning directory for malware signatures");
        let walker = DirectoryWalker::new(WalkConfig::default());
        for file_path in walker.walk_single(path) {
            // Skip config files and binary files
            if !is_config_file(&file_path)
                && is_text_file(&file_path)
                && let Ok(content) = fs::read_to_string(&file_path)
            {
                findings.extend(db.scan_content(&content, &file_path.display().to_string()));
            }
        }
    }

    findings
}

#[cfg(test)]
mod tests {
    use super::*;
    use std::io::Write;
    use tempfile::TempDir;

    #[test]
    fn test_scan_path_with_malware_db_file() {
        let temp_dir = TempDir::new().unwrap();
        let file_path = temp_dir.path().join("test.md");

        // Create a file with content that won't match any signatures
        let mut file = fs::File::create(&file_path).unwrap();
        writeln!(file, "# Normal content").unwrap();

        let db = MalwareDatabase::default();
        let findings = scan_path_with_malware_db(&file_path, &db);
        assert!(findings.is_empty());
    }

    #[test]
    fn test_scan_path_with_malware_db_directory() {
        let temp_dir = TempDir::new().unwrap();
        let file_path = temp_dir.path().join("test.md");

        let mut file = fs::File::create(&file_path).unwrap();
        writeln!(file, "# Normal directory content").unwrap();

        let db = MalwareDatabase::default();
        let findings = scan_path_with_malware_db(temp_dir.path(), &db);
        assert!(findings.is_empty());
    }

    #[test]
    fn test_scan_path_skips_config_files() {
        let temp_dir = TempDir::new().unwrap();
        let config_path = temp_dir.path().join(".cc-audit.yaml");

        let mut file = fs::File::create(&config_path).unwrap();
        writeln!(file, "# Config file content").unwrap();

        let db = MalwareDatabase::default();
        let findings = scan_path_with_malware_db(&config_path, &db);
        assert!(findings.is_empty());
    }
}
